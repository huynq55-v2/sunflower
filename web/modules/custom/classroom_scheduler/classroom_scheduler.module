<?php

use Drupal\node\NodeInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\node\Entity\Node;

/**
 * Implements hook_node_update().
 */
function classroom_scheduler_node_update(NodeInterface $node) {
  if ($node->bundle() !== 'lesson') {
    return;
  }

  $old_value = $node->original->get('field_is_happened')->value ?? 0;
  $new_value = $node->get('field_is_happened')->value ?? 0;

  /** @var \Drupal\node\NodeInterface $classroom */
  $classroom = $node->get('field_classroom')->entity;
  if (!$classroom) {
    \Drupal::messenger()->addError('KhÃ´ng tÃ¬m tháº¥y lá»›p há»c.');
    return;
  }

  $fee = (int) $classroom->get('field_fee')->value;
  $teacher = $classroom->get('field_teacher')->entity ?? NULL;
  $students = $classroom->get('field_student_list')->referencedEntities();

  if ($fee <= 0 || !$teacher) {
    \Drupal::messenger()->addError('Lá»›p há»c chÆ°a cÃ³ há»c phÃ­ hoáº·c giÃ¡o viÃªn.');
    return;
  }

  $lesson_label = $node->label();
  $class_label = $classroom->label();

  // ========== CASE 1: Chuyá»ƒn tá»« "chÆ°a há»c" -> "Ä‘Ã£ há»c" ==========
  if ($old_value == 0 && $new_value == 1) {
    foreach ($students as $student) {
      if (!$student->hasField('field_account_balance')) continue;

      $balance = (int) $student->get('field_account_balance')->value;
      $new_balance = $balance - $fee;
      $student->set('field_account_balance', $new_balance);
      $student->save();

      $transaction = Node::create([
        'type' => 'transaction',
        'title' => "Giao dá»‹ch {$lesson_label} - Há»c sinh",
        'field_user' => ['target_id' => $student->id()],
        'field_lesson' => ['target_id' => $node->id()],
        'field_classroom' => ['target_id' => $classroom->id()],
        'field_amount' => $fee,
        'field_type' => 'debit',
        'field_balance_after' => $new_balance,
      ]);
      $transaction->save();
    }

    // GiÃ¡o viÃªn Ä‘Æ°á»£c cá»™ng tá»•ng tiá»n há»c sinh
    $total_credit = count($students) * $fee;
    if ($teacher->hasField('field_account_balance')) {
      $balance = (int) $teacher->get('field_account_balance')->value;
      $new_balance = $balance + $total_credit;
      $teacher->set('field_account_balance', $new_balance);
      $teacher->save();

      $transaction = Node::create([
        'type' => 'transaction',
        'title' => "Giao dá»‹ch {$lesson_label} - GiÃ¡o viÃªn",
        'field_user' => ['target_id' => $teacher->id()],
        'field_lesson' => ['target_id' => $node->id()],
        'field_classroom' => ['target_id' => $classroom->id()],
        'field_amount' => $total_credit,
        'field_type' => 'credit',
        'field_balance_after' => $new_balance,
      ]);
      $transaction->save();
    }

    \Drupal::messenger()->addStatus("âœ… ÄÃ£ táº¡o giao dá»‹ch cho buá»•i há»c {$lesson_label}.");
  }

  // ========== CASE 2: Chuyá»ƒn tá»« "Ä‘Ã£ há»c" -> "chÆ°a há»c" (Undo) ==========
  if ($old_value == 1 && $new_value == 0) {
    $query = \Drupal::entityQuery('node')
      ->condition('type', 'transaction')
      ->condition('field_lesson', $node->id())
      ->accessCheck(FALSE);
    $transaction_ids = $query->execute();

    if ($transaction_ids) {
      $transactions = \Drupal\node\Entity\Node::loadMultiple($transaction_ids);

      // Gom theo user Ä‘á»ƒ recalculation sau khi xÃ³a.
      $affected_users = [];

      foreach ($transactions as $txn) {
        $user = $txn->get('field_user')->entity;
        if (!$user) continue;
        $affected_users[$user->id()] = $user;

        // ðŸ§© XÃ³a transaction cá»§a buá»•i há»c bá»‹ há»§y
        $txn->delete();
      }

      // ðŸ§© Recalculate láº¡i balance cho tá»«ng user bá»‹ áº£nh hÆ°á»Ÿng
      foreach ($affected_users as $uid => $user) {
        // ðŸ’¡ Láº¥y Táº¤T Cáº¢ cÃ¡c node tÃ i chÃ­nh liÃªn quan Ä‘áº¿n user nÃ y
        $query_all = \Drupal::entityQuery('node')
          ->condition('type', ['transaction', 'transaction_log'], 'IN')
          ->sort('created', 'ASC')
          ->accessCheck(FALSE);

        // *** Sá»¬A Lá»–I Táº I ÄÃ‚Y ***
        // Táº¡o má»™t nhÃ³m Ä‘iá»u kiá»‡n OR Ä‘á»ƒ tÃ¬m user trÃªn cáº£ 2 trÆ°á»ng khÃ¡c nhau
        $user_condition_group = $query_all->orConditionGroup()
          ->condition('field_user', $uid)
          ->condition('field_student', $uid); // Giáº£ sá»­ field_student cÅ©ng tham chiáº¿u Ä‘áº¿n User

        // Ãp dá»¥ng nhÃ³m Ä‘iá»u kiá»‡n vÃ o query chÃ­nh
        $query_all->condition($user_condition_group);

        $all_ids = $query_all->execute();

        $running_balance = 0;
        if ($all_ids) {
          $all_txns = \Drupal\node\Entity\Node::loadMultiple($all_ids);

          foreach ($all_txns as $t) {
            $bundle = $t->bundle();
            $amount = (int) $t->get('field_amount')->value;

            if ($bundle === 'transaction') {
              $type = $t->get('field_type')->value;
              if ($type === 'debit') {
                $running_balance -= $amount;
              } else {
                $running_balance += $amount;
              }
            }
            elseif ($bundle === 'transaction_log') {
              $running_balance += $amount;
            }

            if ($t->hasField('field_balance_after')) {
              $t->set('field_balance_after', $running_balance);
              $t->save();
            }
          }
        }

        // Cáº­p nháº­t láº¡i sá»‘ dÆ° cuá»‘i cÃ¹ng trong tÃ i khoáº£n cá»§a user
        $user->set('field_account_balance', $running_balance);
        $user->save();
      }

      \Drupal::messenger()->addStatus("â†©ï¸ ÄÃ£ xÃ³a giao dá»‹ch cá»§a buá»•i há»c vÃ  cáº­p nháº­t láº¡i lá»‹ch sá»­ tÃ i khoáº£n.");
    }
  }
}

/**
 * Implements hook_form_alter().
 */
function classroom_scheduler_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if ($form_id === 'node_lesson_form') {
    $request = \Drupal::request();
    $classroom_id = $request->query->get('field_classroom');

    if ($classroom_id && ($classroom = Node::load($classroom_id))) {
      // âœ… Äiá»n sáºµn classroom.
      $form['field_classroom']['widget'][0]['target_id']['#default_value'] = $classroom;

      // KhÃ³a field láº¡i, user khÃ´ng thay Ä‘á»•i Ä‘Æ°á»£c.
      $form['field_classroom']['widget'][0]['target_id']['#disabled'] = TRUE;
      $form['field_classroom']['widget'][0]['target_id']['#attributes']['readonly'] = 'readonly';

      // âœ… TÃ­nh sá»‘ buá»•i há»c hiá»‡n cÃ³.
      $query = \Drupal::entityTypeManager()->getStorage('node')->getQuery();
      $query->condition('type', 'lesson');
      $query->condition('field_classroom', $classroom_id);
      $query->accessCheck(FALSE); // Bá» check quyá»n Ä‘á»ƒ Ä‘áº¿m chÃ­nh xÃ¡c
      $count = $query->count()->execute();

      // âœ… Gá»£i Ã½ Title: "TÃªn lá»›p há»c buá»•i {count+1}".
      $next_number = $count + 1;
      $title_suggest = $classroom->label() . ' buá»•i ' . str_pad($next_number, 2, '0', STR_PAD_LEFT);

      // GÃ¡n vÃ o Title máº·c Ä‘á»‹nh.
      $form['title']['widget'][0]['value']['#default_value'] = $title_suggest;
    }
  }
}
