<?php

use Drupal\node\Entity\Node;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_entity_presave().
 *
 * Triggered before a node is saved.
 */
function sunflower_classroom_entity_presave(EntityInterface $entity) {
  // Chỉ xử lý với content type "classroom" và "lesson".
  if ($entity->getEntityTypeId() !== 'node' || !in_array($entity->bundle(), ['classroom', 'lesson'])) {
    return;
  }

  // Nếu là node mới, Drupal chưa gán ID → xử lý sau khi insert.
  // Nếu là node đã tồn tại (edit) → tạo account ngay.
  if (!$entity->isNew()) {
    _sunflower_school_create_user_accounts($entity);
  }
}

/**
 * Implements hook_entity_insert().
 *
 * Triggered after a new node is saved.
 */
function sunflower_classroom_entity_insert(EntityInterface $entity) {
  // Chỉ xử lý với content type "classroom" và "lesson".
  if ($entity->getEntityTypeId() !== 'node' || !in_array($entity->bundle(), ['classroom', 'lesson'])) {
    return;
  }

  _sunflower_school_create_user_accounts($entity);
}

/**
 * Tạo tài khoản cho người dùng (học sinh và giáo viên) liên quan đến một lớp học.
 *
 * Hàm này được gọi khi một node 'classroom' hoặc 'lesson' được tạo/cập nhật.
 *
 * @param \Drupal\node\Entity\Node $entity
 *   Node được tạo hoặc cập nhật ('classroom' hoặc 'lesson').
 */
function _sunflower_school_create_user_accounts(Node $entity) {
  $users_to_process = [];
  $classroom_node = NULL;

  // Xác định content type và thu thập danh sách người dùng cần xử lý.
  $bundle = $entity->bundle();
  if ($bundle === 'classroom') {
    $classroom_node = $entity;
    // Lấy danh sách học sinh từ lớp học.
    if ($entity->hasField('field_student_list') && !$entity->get('field_student_list')->isEmpty()) {
      $users_to_process = array_merge($users_to_process, $entity->get('field_student_list')->referencedEntities());
    }
    // Lấy giáo viên từ lớp học.
    if ($entity->hasField('field_teacher') && !$entity->get('field_teacher')->isEmpty()) {
      $users_to_process[] = $entity->get('field_teacher')->entity;
    }
  } elseif ($bundle === 'lesson') {
    // Nếu là buổi học, lấy thông tin lớp học được tham chiếu.
    if ($entity->hasField('field_classroom') && !$entity->get('field_classroom')->isEmpty()) {
      $classroom_node = $entity->get('field_classroom')->entity;
      if ($classroom_node) {
        // Lấy danh sách học sinh từ buổi học.
        if ($entity->hasField('field_student_list') && !$entity->get('field_student_list')->isEmpty()) {
          $users_to_process = array_merge($users_to_process, $entity->get('field_student_list')->referencedEntities());
        }
        // Lấy giáo viên từ lớp học liên quan.
        if ($classroom_node->hasField('field_teacher') && !$classroom_node->get('field_teacher')->isEmpty()) {
          $users_to_process[] = $classroom_node->get('field_teacher')->entity;
        }
      }
    }
  }

  // Nếu không có thông tin lớp học hoặc không có người dùng nào thì dừng lại.
  if (!$classroom_node || empty($users_to_process)) {
    return;
  }

  $class_id = $classroom_node->id();
  $class_label = $classroom_node->label();

  // Loại bỏ các user bị trùng lặp.
  $unique_users = [];
  foreach ($users_to_process as $user) {
    if ($user) {
      $unique_users[$user->id()] = $user;
    }
  }

  // Duyệt qua danh sách người dùng và tạo tài khoản nếu chưa có.
  foreach ($unique_users as $user) {
    $uid = $user->id();
    $user_label = $user->label();

    // Lấy họ và tên (field_full_name) nếu có
    $full_name = '';
    if ($user->hasField('field_full_name') && !$user->get('field_full_name')->isEmpty()) {
      $full_name = $user->get('field_full_name')->value;
    }

    // Ghép lại tiêu đề
    $title = "Tài khoản cho: " . $user_label;

    if (!empty($full_name)) {
      $title .= " (" . $full_name . ")";
    }


    $title .= ' - Lớp: ' . $class_label;

    // Kiểm tra xem tài khoản cho user này trong lớp học này đã tồn tại chưa.
    $query = \Drupal::entityQuery('node')
      ->condition('type', 'account')
      ->condition('field_student', $uid) // Field này lưu User (cả học sinh và giáo viên)
      ->condition('field_classroom', $class_id)
      ->accessCheck(FALSE);
    $existing_accounts = $query->execute();

    if (empty($existing_accounts)) {
      // Nếu chưa tồn tại, tạo một node 'account' mới.
      $account = Node::create([
        'type' => 'account',
        'title' => $title,
        'field_student' => $uid,
        'field_classroom' => $class_id,
      ]);
      $account->save();

      \Drupal::logger('sunflower_classroom')->notice('Đã tạo tài khoản cho @user trong lớp @class', [
        '@user' => $user_label,
        '@class' => $class_label,
      ]);
    }
  }
}

/**
 * Implements hook_views_post_execute().
 */
function sunflower_classroom_views_post_execute(\Drupal\views\ViewExecutable $view) {
  if ($view->id() === 'student_by_class_remove') {
    $class_nid = $view->args[0] ?? 0;
    if (!$class_nid) return;

    $class_node = \Drupal\node\Entity\Node::load($class_nid);
    if (!$class_node || !$class_node->hasField('field_student_list')) return;

    $student_refs = $class_node->get('field_student_list')->referencedEntities();
    $student_uids = array_map(fn($u) => $u->id(), $student_refs);

    $view->result = array_filter($view->result, fn($row) => in_array($row->_entity->id(), $student_uids));
  }

  // if ($view->id() === 'student_by_class_add') {
  //   $class_nid = $view->args[0] ?? 0;
  //   if (!$class_nid) return;

  //   $class_node = \Drupal\node\Entity\Node::load($class_nid);
  //   if (!$class_node || !$class_node->hasField('field_student_list')) return;

  //   $student_refs = $class_node->get('field_student_list')->referencedEntities();
  //   $student_uids = array_map(fn($u) => $u->id(), $student_refs);

  //   // Lọc chỉ giữ những user KHÔNG có trong lớp
  //   $view->result = array_filter($view->result, fn($row) => !in_array($row->_entity->id(), $student_uids));
  // }

  // Bỏ qua khi chạy trong môi trường không có request thật (vd: admin preview, cron, Drush).
  $request_stack = \Drupal::service('request_stack');
  $request = $request_stack->getCurrentRequest();

  if (!$request) {
    \Drupal::logger('sunflower_classroom')->warning('No current request available for view @view.', ['@view' => $view->id()]);
    // Đừng return ở đây — chỉ bỏ qua xử lý thêm.
    return;
  }

  // Xử lý session cho các view add/remove học sinh.
  if (in_array($view->id(), ['student_by_class_add', 'student_by_class_remove'])) {
    $session = $request->getSession();
    $current_path = $request->getPathInfo();

    // Nếu URL có arg thì lưu vào session.
    if (preg_match('#student-by-class-(add|remove)/(\d+)#', $current_path, $m)) {
      $session->set('sunflower_current_class', (int) $m[2]);
      \Drupal::logger('sunflower_classroom')->notice('Saved current class nid=@nid from path @path', [
        '@nid' => $m[2],
        '@path' => $current_path,
      ]);
    }

    // Lấy lại nếu là request AJAX (view không có args).
    if (empty($view->args[0])) {
      $saved = $session->get('sunflower_current_class');
      if ($saved) {
        $view->args[0] = $saved;
        \Drupal::logger('sunflower_classroom')->notice('Restored class nid=@nid from session for view @view', [
          '@nid' => $saved,
          '@view' => $view->id(),
        ]);
      }
      else {
        \Drupal::logger('sunflower_classroom')->warning('No saved class nid found in session for view @view', [
          '@view' => $view->id(),
        ]);
      }
    }
  }
}

use Drupal\views\ViewExecutable;

/**
 * Implements hook_views_pre_execute().
 */
function sunflower_classroom_views_pre_execute(ViewExecutable $view) {
  if ($view->id() === 'student_list_by_class' && $view->current_display === 'data_export_1') {
    if (!empty($view->args[0]) && is_numeric($view->args[0])) {
      $node = \Drupal::entityTypeManager()->getStorage('node')->load($view->args[0]);
      if ($node) {
        // Đặt lại title của view để token [view:title] dùng được.
        $view->setTitle($node->label());
      }
    }
  }

  // View: Danh sách tài khoản.
  if ($view->id() === 'account_list' && $view->current_display === 'data_export_1') {
    if (!empty($view->args[0]) && is_numeric($view->args[0])) {
      $user = \Drupal::entityTypeManager()->getStorage('user')->load($view->args[0]);
      if ($user) {
        // Đặt tiêu đề của view bằng tên người dùng.
        $view->setTitle($user->getDisplayName() . ' ' . $user->get('field_full_name')->value);
      }
    }
  }
}

use Drupal\views\Plugin\views\query\QueryPluginBase;

/**
 * Implements hook_views_query_alter().
 */
function sunflower_classroom_views_query_alter(ViewExecutable $view, QueryPluginBase $query) {
  if ($view->id() === 'student_by_class_add' && $view->current_display === 'page_1') {

    $class_nid = (int) ($view->args[0] ?? 0);

    // ✅ 1. Loại bỏ tất cả join tới node_field_data để tránh điều kiện sai.
    unset($query->tables['node__field_student_list']);
    unset($query->tables['field_student_list_users_field_data']);

    // ✅ 2. Xóa mọi điều kiện liên quan đến nid.
    foreach ($query->where as &$group) {
      foreach ($group['conditions'] as $key => $condition) {
        if (is_array($condition)
          && isset($condition['field'])
          && strpos($condition['field'], 'field_student_list_users_field_data.nid') !== FALSE) {
          unset($group['conditions'][$key]);
        }
      }
    }

    // ✅ 3. Thêm subquery NOT IN (chuẩn Drupal)
    $subquery = \Drupal::database()->select('node__field_student_list', 'nsl');
    $subquery->addField('nsl', 'field_student_list_target_id');
    $subquery->condition('nsl.entity_id', $class_nid);
    $subquery->condition('nsl.deleted', 0);

    $query->addWhere(0, 'users_field_data.uid', $subquery, 'NOT IN');
  }
}