<?php

use Drupal\node\Entity\Node;

/**
 * Implements hook_entity_presave().
 */
function sunflower_classroom_entity_presave(\Drupal\Core\Entity\EntityInterface $entity) {
  // Chá»‰ xá»­ lÃ½ vá»›i content type "classroom"
  if ($entity->getEntityTypeId() !== 'node' || $entity->bundle() !== 'classroom') {
    return;
  }

  // Náº¿u lÃ  node má»›i, Drupal chÆ°a gÃ¡n ID â†’ xá»­ lÃ½ sau khi insert
  if ($entity->isNew()) {
    \Drupal::service('module_handler')->invoke('sunflower_classroom', 'pending_create_accounts', [$entity]);
    return;
  }

  // Náº¿u lÃ  node Ä‘Ã£ tá»“n táº¡i (edit) â†’ táº¡o account ngay
  _sunflower_classroom_create_accounts($entity);
}

/**
 * Implements hook_entity_insert().
 */
function sunflower_classroom_entity_insert(\Drupal\Core\Entity\EntityInterface $entity) {
  if ($entity->getEntityTypeId() !== 'node' || $entity->bundle() !== 'classroom') {
    return;
  }

  _sunflower_classroom_create_accounts($entity);
}

/**
 * Táº¡o account cho há»c sinh vÃ  giÃ¡o viÃªn cá»§a lá»›p há»c.
 */
function _sunflower_classroom_create_accounts(\Drupal\node\Entity\Node $entity) {
  $class_id = $entity->id();
  $class_label = $entity->label();

  // ðŸ§© Táº¡o account cho há»c sinh
  if ($entity->hasField('field_student_list')) {
    $student_refs = $entity->get('field_student_list')->referencedEntities();

    foreach ($student_refs as $student) {
      $uid = $student->id();

      // Kiá»ƒm tra account há»c sinh + lá»›p nÃ y Ä‘Ã£ tá»“n táº¡i chÆ°a
      $query = \Drupal::entityQuery('node')
        ->condition('type', 'account')
        ->condition('field_student', $uid)
        ->condition('field_classroom', $class_id)
        ->accessCheck(FALSE);

      $existing = $query->execute();

      if (empty($existing)) {
        $account = Node::create([
          'type' => 'account',
          'title' => "TÃ i khoáº£n há»c sinh: " . $student->label() . ' - ' . $class_label,
          'field_student' => $uid,
          'field_classroom' => $class_id,
        ]);
        $account->save();

        \Drupal::logger('sunflower_classroom')->notice('ÄÃ£ táº¡o tÃ i khoáº£n há»c sinh cho @student trong lá»›p @class', [
          '@student' => $student->label(),
          '@class' => $class_label,
        ]);
      }
    }
  }

  // ðŸ§© Táº¡o account cho giÃ¡o viÃªn
  if ($entity->hasField('field_teacher') && !$entity->get('field_teacher')->isEmpty()) {
    $teacher = $entity->get('field_teacher')->entity;
    if ($teacher) {
      $teacher_uid = $teacher->id();

      // Kiá»ƒm tra account giÃ¡o viÃªn + lá»›p nÃ y Ä‘Ã£ tá»“n táº¡i chÆ°a
      $query = \Drupal::entityQuery('node')
        ->condition('type', 'account')
        ->condition('field_student', $teacher_uid)
        ->condition('field_classroom', $class_id)
        ->accessCheck(FALSE);

      $existing_teacher_accounts = $query->execute();

      if (empty($existing_teacher_accounts)) {
        $account = Node::create([
          'type' => 'account',
          'title' => "TÃ i khoáº£n giÃ¡o viÃªn: " . $teacher->label() . ' - ' . $class_label,
          'field_student' => $teacher_uid,
          'field_classroom' => $class_id,
        ]);
        $account->save();

        \Drupal::logger('sunflower_classroom')->notice('ÄÃ£ táº¡o tÃ i khoáº£n giÃ¡o viÃªn @teacher cho lá»›p @class', [
          '@teacher' => $teacher->label(),
          '@class' => $class_label,
        ]);
      }
    }
  }
}
